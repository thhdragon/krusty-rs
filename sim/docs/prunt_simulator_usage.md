# Prunt Simulator Deep Dive & Usage Guide

## Overview
The Prunt Simulator is a high-fidelity simulation environment for the Prunt motion controller, designed to test, debug, and visualize G-code execution and motion planning algorithms. It simulates a 3D printer's kinematics, stepper behavior, and outputs detailed motion data for analysis and plotting.

---

## Features
- **G-code execution**: Simulate standard G-code files (e.g., `test.gcode`).
- **Motion planning**: Emulates kinematics, acceleration, jerk, snap, and crackle.
- **Live data output**: Streams position and motion data for real-time plotting.
- **Configurable**: Uses TOML/JSON config files for kinematics, steppers, heaters, etc.
- **Python plotting**: Visualize motion profiles and kinematic derivatives with provided scripts.

---

## Directory Structure
- `src/` — Ada source code for the simulator core
- `prunt_simulator.gpr` — GNAT project file for building
- `prunt_sim.toml` / `prunt_sim.json` — Configuration files
- `test.gcode` — Example G-code input
- `run.sh` — Helper script to run the simulator and extract CSV data
- `plot.py` / `continuous_plot.py` — Python scripts for plotting output

---

## Building the Simulator
1. **Dependencies**:
   - Ada compiler (GNAT)
   - Python 3 with `matplotlib`, `numpy`, `scipy`
2. **Build**:
   ```sh
   gprbuild -P prunt_simulator.gpr
   ```
   Output binary: `bin/prunt_simulator`

---

## Running a Simulation
### 1. Basic Run
```sh
./bin/prunt_simulator < test.gcode
```
- Processes the G-code and outputs motion data to stdout.

### 2. With CSV Extraction (for plotting)
```sh
./run.sh < test.gcode
```
- Runs the simulator and extracts relevant data to `tmp.csv`.

### 3. Live Plotting
#### a) Continuous Plot
```sh
stdbuf -oL -eL ./bin/prunt_simulator < test.gcode | stdbuf -oL -eL python3 continuous_plot.py
```
- Streams data directly to the live plotter.

#### b) Static Plot
After running `run.sh`, plot the results:
```sh
python3 plot.py
```
- Plots the data from `tmp.csv`.

---

## Configuration
- **`prunt_sim.toml`** and **`prunt_sim.json`** define kinematics, steppers, heaters, fans, and more.
- Adjust these files to simulate different hardware or motion profiles.

---

## Output Data Format
- Simulator outputs lines starting with `DATA OUTPUT,` followed by comma-separated X, Y, Z, E positions.
- Python scripts parse this for plotting position, velocity, acceleration, jerk, snap, and crackle.

---

## Example Workflow
1. Edit `test.gcode` with your G-code.
2. (Optional) Adjust `prunt_sim.toml`/`prunt_sim.json` for your scenario.
3. Build the simulator.
4. Run simulation with `run.sh` or direct command.
5. Visualize with `plot.py` or `continuous_plot.py`.

---

## Advanced Usage
- **Custom configs**: Point the simulator to a different config file by editing the source or symlinking.
- **Plot customization**: Edit the Python scripts to change what is plotted or add new analyses.

---

## References
- See `README.org` for additional notes.
- Source code: `src/prunt_simulator.adb`
- Example G-code: `test.gcode`

---

## Troubleshooting
- Ensure all dependencies are installed.
- If plots do not appear, check that `tmp.csv` is generated and not empty.
- For Ada build errors, verify GNAT toolchain is installed and up to date.

---

*This document was generated by an automated deep dive of the Prunt Simulator codebase and scripts.*
